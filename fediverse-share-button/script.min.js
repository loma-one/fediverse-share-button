(async()=>{const canUseLocalStorage=localStorage.getItem("fsb-consent-given")!=="false"?true:false;const knownSoftware=["activitypods","akkoma","anacus","andstatus","anfora","audon","awakari","azorius","bonfire","bookwyrm","bridgy_fed","brighteon_social","brutalinks","buttondown","calckey","castopod","chatter_net","chirp","communecter","diaspora","discourse","dolphin","drupal","emissary","epicyon","f2ap","fedibird","fedify","firefish","flipboard","flockingbird","flohmarkt","forgeflex","forgefriends","forgejo","foundkey","friendica","funkwhale","gancio","gath.io","ghost","gitlab","glitch-soc","gnu_social","goblin","goldfish","gotosocial","greatape","guppe","hollo","hometown","honk","hubzilla","iceshrimp","immers","juick","kazarma","kbin","kepi","ktistec","lemmy","libervia","loforo","loops","mangane","mastodon","mbin","micro.blog","minds","misskey","mistpark","mitra","mobilizon","neodb","nextcloud_social","nodebb","notestock","openengiadina","osada","owncast","peertube","piefed","pinetta","pixelfed","pleroma","plume","podcast_index","postmarks","prismo","quanta","rebased","redaktor","redmatrix","reel2bits","ruffy","seppo","sharky","shuttlecraft","skohub","smithereen","snac","soapbox","socialhome","streams","sublinks","swanye","takahe","takesama","threads","vernissage","viverse","vocata","wafrn","wildebeest","wordpress","write.as","writefreely","wxwclub","xwiki","yeet","zap"];const supportedSoftware=["diaspora","firefish","friendica","glitch-soc","hometown","hubzilla","lemmy","mastodon","misskey","pleroma","sharkey","threads"];const notes={lemmy:`Older lemmy servers <a href="https://github.com/LemmyNet/lemmy-ui/issues/1913" target="_blank">may not work correctly</a>.`};const getFSBPath=()=>{var scripts=document.getElementsByClassName("fsb-script")[0];src=scripts.src;return src.replace("/script.min.js","")};const updateTheIcon=(iconElement,software)=>{const domainInput=iconElement.parentElement.parentElement.parentElement.getElementsByClassName("fsb-domain")[0];iconElement.src=`${getFSBPath()}/icons/${software}.svg`;iconElement.alt=`${software} platform logo`};const updateIcon=async domainInput=>{clearTimeout(typingTimer);if(domainInput.value){typingTimer=setTimeout((()=>{doneTyping(domainInput)}),doneTypingInterval)}else{const iconEl=domainInput.parentElement.getElementsByClassName("fsb-icon")[0];updateTheIcon(iconEl,"mastodon")}};const hidePlatformSupportVisibilityNote=shareBtn=>{const supportNote=shareBtn.parentElement.parentElement.getElementsByClassName("fsb-support-note")[0];supportNote.classList.add("fsb-d-none")};const checkPlatformSupport=shareBtn=>{const supportNote=shareBtn.parentElement.parentElement.getElementsByClassName("fsb-support-note")[0];const domainInput=shareBtn.parentElement.parentElement.getElementsByClassName("fsb-domain")[0];supportNote.classList.add("fsb-d-none");let note=shareBtn.parentElement.parentElement.getElementsByClassName("fsb-note")[0];if(!note){note=document.createElement("p");note.classList.add("fsb-note");note.classList.add("fsb-d-none");supportNote.parentNode.insertBefore(note,supportNote.nextSibling)}const supportNoteLink=shareBtn.parentElement.parentElement.getElementsByClassName("fsb-support-note-link")[0];if(note){note.classList.add("fsb-d-none")}if(!supportedSoftware.includes(window.fsbGlobalSoftware)){supportNoteLink.href=`https://${domainInput.value}`;supportNoteLink.innerHTML=domainInput.value;supportNote.classList.remove("fsb-d-none")}if(note&&notes[window.fsbGlobalSoftware]){note.innerHTML=notes[window.fsbGlobalSoftware];note.classList.remove("fsb-d-none")}};const doneTyping=async el=>{const shareBtn=el.parentElement.getElementsByClassName("fsb-button")[0];const domain=getDomain(el.value);const resp=await fetch(`https://fediverse-info.stefanbohacek.dev/node-info?domain=${domain}&onlysoftware=true`);shareBtn.innerHTML=shareBtn.innerHTML.replace("Loading","Share");const respJSON=await resp.json();const software=respJSON?.software?.name;const iconEl=el.parentElement.getElementsByClassName("fsb-icon")[0];el.dataset.software=software;window.fsbGlobalSoftware=software;checkPlatformSupport(shareBtn);if(software&&knownSoftware.includes(software)){updateTheIcon(iconEl,software);if(supportedSoftware.includes(software)){shareBtn.disabled=false}}else{updateTheIcon(iconEl,"question")}};const getPageTitle=()=>{let pageTitle=document.title;try{pageTitle=document.querySelector("meta[property='og:title']").getAttribute("content")}catch(error){}return encodeURIComponent(pageTitle)};const getPageDescription=()=>{let pageDescription="";const metaDescription=document.querySelector("meta[name='description']")||document.querySelector("meta[property='og:description']")||null;if(metaDescription&&metaDescription.getAttribute){pageDescription=metaDescription.getAttribute("content")}return encodeURIComponent(pageDescription)};const getPageURL=()=>encodeURIComponent(window.location.href);const getDomain=str=>str.replace(/(^\w+:|^)\/\//,"");const truncate=input=>input.length>5?`${input.substring(0,450)}...`:input;const getSelectedText=()=>{let text="";if(window.getSelection){text=window.getSelection().toString()}else if(document.selection&&document.selection.type!="Control"){text=document.selection.createRange().text}return truncate(text)};let typingTimer;const doneTypingInterval=1300;const savedDomain=canUseLocalStorage?localStorage.getItem("fsb-domain"):false;const savedSoftware=canUseLocalStorage?localStorage.getItem("fsb-software"):false;if(savedSoftware){window.fsbGlobalSoftware=savedSoftware}[...document.getElementsByClassName("fsb-prompt")].forEach((fsbPrompt=>{const domainInput=fsbPrompt.getElementsByClassName("fsb-domain")[0];const shareBtn=fsbPrompt.getElementsByClassName("fsb-button")[0];if(savedDomain){domainInput.value=savedDomain;if(savedSoftware){domainInput.dataset.software=savedSoftware;shareBtn.disabled=true;const iconEl=domainInput.parentElement.getElementsByClassName("fsb-icon")[0];updateTheIcon(iconEl,savedSoftware);if(supportedSoftware.includes(savedSoftware)){shareBtn.disabled=false}}else{updateIcon(domainInput)}}domainInput.addEventListener("input",(()=>{shareBtn.disabled=true;const iconEl=domainInput.parentElement.getElementsByClassName("fsb-icon")[0];hidePlatformSupportVisibilityNote(shareBtn);updateTheIcon(iconEl,"question");if(domainInput.value){shareBtn.innerHTML=shareBtn.innerHTML.replace("Share","Loading")}else{updateTheIcon(iconEl,"question");shareBtn.innerHTML=shareBtn.innerHTML.replace("Loading","Share")}updateIcon(domainInput)}));domainInput.addEventListener("change",(()=>{}));fsbPrompt.addEventListener("submit",(ev=>{ev.preventDefault();const domain=getDomain(domainInput?.value?.trim());if(domain?.length){const shareText=getSelectedText()||getPageTitle();if(canUseLocalStorage){localStorage.setItem("fsb-domain",domain);if(window.fsbGlobalSoftware){localStorage.setItem("fsb-software",window.fsbGlobalSoftware)}}let shareURL=`https://${domain}/share?text=${shareText+"%0A%0A"+getPageURL()}`;if(domainInput?.dataset?.software){if(["diaspora","friendica"].includes(domainInput.dataset.software)){shareURL=`https://${domain}/bookmarklet?url=${getPageURL()}&title=${shareText}&note=${getPageDescription()}`}else if(domainInput.dataset.software==="hubzilla"){shareURL=`https://${domain}/rpost?url=${getPageURL()}&body=${shareText}[br][br]`}else if(domainInput.dataset.software==="lemmy"){shareURL=`https://${domain}/create_post?title=${shareText}&url=${getPageURL()}&body=${getPageDescription()}`}else if(domainInput.dataset.software==="threads"){shareURL=`https://${domain}/intent/post?text=${shareText+"%0A%0A"+getPageURL()}`}}window.location.assign(shareURL)}}))}))})();
